<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<title>Spank Game — 可愛風 / 酷炫風</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --container-w: min(95vw, 1200px);
    --gap: 16px;
    --glass: rgba(0,0,0,0.08);
    --light-bg1:#fff8fb; --light-bg2:#fff;
    --accent:#ff6b9a;
  }

  html,body{height:100%;margin:0;font-family:"Microsoft JhengHei",system-ui,-apple-system,Segoe UI,Arial,sans-serif}
  body{
    background: var(--light-bg1);
    display:flex; align-items:flex-start; justify-content:center;
    padding: clamp(12px, 2vw, 24px);
  }

  /* 容器：會隨螢幕放大，不再擠在中間 */
  .app{
    width: var(--container-w);
    border-radius: 14px; overflow:hidden;
    box-shadow: 0 16px 48px rgba(0,0,0,.12);
    background: linear-gradient(180deg,var(--light-bg2),#fff);
  }

  /* 頂部列 */
  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    padding: 14px clamp(14px, 2vw, 22px);
    gap: 12px;
  }
  .title{font-weight: 900; font-size: clamp(18px, 2.2vw, 28px)}
  .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  select, button{
    padding: 10px 12px; border-radius: 10px; border:none; cursor:pointer;
    font-weight: 700; font-size: 15px;
  }
  #drawBtn{ background: linear-gradient(90deg,#ff6b9a,#ff85a2); color:#fff }
  #stopBtn{ background: #ffb86b; color:#000 }
  #resetBtn{ background: #bdbdbd; color:#021 }
  #drawBtn:disabled,#stopBtn:disabled{ opacity:.55; cursor:not-allowed }

  /* 主要版面：左右分欄（左：結果與按鈕；右：說明與歷史） */
  .layout{
    display:grid;
    gap: var(--gap);
    padding: clamp(12px, 2vw, 20px);
    grid-template-columns: 1.6fr 1fr; /* 大螢幕更寬敞 */
    align-items:start;
  }

  /* 左欄 */
  .leftCol{ display:grid; gap: var(--gap) }
  .stats{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center
  }
  .stat{
    padding: 10px 12px; border-radius: 10px; font-weight: 800; font-size: 14px
  }
  .stat.score{ background:linear-gradient(180deg,#fff9db,#fff2c2); color:#a65a00 }
  .stat.redButt{ background:linear-gradient(180deg,#ffe9e9,#ffdede); color:#b33a3a }
  .stat.total{ background:linear-gradient(180deg,#eaf7ff,#d9f0ff); color:#0b6d91 }

  /* 抽籤結果：獨立大卡片，醒目 */
  .resultCard{
    padding: clamp(16px, 2vw, 22px);
    border-radius: 14px;
    background: linear-gradient(180deg,#ffffff,#fff9f5);
    box-shadow: inset 0 2px 6px rgba(0,0,0,.03);
    min-height: clamp(88px, 12vh, 150px);
    display:flex; align-items:center; justify-content:center;
  }
  #result{
    font-size: clamp(20px, 2.4vw, 30px);
    font-weight: 900;
    text-align:center;
    color:#d6336c;
  }

  /* 按鈕區固定在左欄下方，不與結果同一塊 */
  .btnRow{
    display:flex; gap:10px; flex-wrap:wrap;
  }

  /* 右欄：說明 + 歷史紀錄 */
  .rightCol{ display:grid; gap: var(--gap) }
  .card{
    background: rgba(255,255,255,0.96);
    border-radius: 12px;
    padding: clamp(12px, 2vw, 18px);
    box-shadow: 0 6px 18px var(--glass);
  }
  .card h3{ margin:4px 0 10px 0 }
  #history{
    max-height: clamp(150px, 22vh, 280px); /* 右側歷史區較小，避免擠壓 */
    overflow: auto;
  }
  .history-item{
    padding: 8px 2px; border-bottom: 1px solid #eee; font-size: 14px; color:#333
  }
  .history-item:last-child{ border-bottom:none }

  /* 進場動畫 */
  .pop{ animation:pop .55s ease forwards; color:var(--accent)}
  @keyframes pop{0%{transform:scale(.6);opacity:0}70%{transform:scale(1.12);opacity:1}100%{transform:scale(1)}}

  /* 模式選單 Overlay */
  #modeSelectOverlay{
    position: fixed; inset: 0; z-index: 50;
    display:flex; align-items:center; justify-content:center;
    background: linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.45));
    padding: 20px;
  }
  .modeBox{
    width: min(100%, 980px);
    display:grid; gap: 16px;
    grid-template-columns: 1fr 1fr;
  }
  .modeItem{
    border-radius: 14px; padding: 18px; text-align:center;
    box-shadow: 0 18px 50px rgba(0,0,0,.25);
  }
  .modeLight{ background: linear-gradient(180deg,#fff,#fff8fb); border:1px solid #ffd6e8 }
  .modeDark{ background: linear-gradient(180deg,#061018,#071522); border:1px solid rgba(255,255,255,.06); color:#e6f7ff }
  .modeBtn{ margin-top: 12px; padding: 12px 18px; border-radius: 10px; border:none; font-weight: 900; cursor:pointer }
  .modeBtnLight{ background:#ff6b9a; color:#fff }
  .modeBtnDark{ background:#00d7ff; color:#022 }

  /* 深色 / 螢光風格 */
  .theme-dark body, .theme-dark{ background: linear-gradient(180deg,#041018,#031018) }
  .theme-dark .app{ background: linear-gradient(180deg,#071322,#041018); color:#e8f6ff }
  .theme-dark .card{ background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); color:#dbeefe }
  .theme-dark .resultCard{ background: linear-gradient(180deg,#071322,#041018); box-shadow: inset 0 2px 10px rgba(0,0,0,.6) }
  .neon-h1{ color:#00ffff; text-shadow:0 0 8px #00ffff,0 0 20px rgba(0,255,255,0.10) }
  .neon-result{ color:#ff80ff; text-shadow:0 0 10px #ff66ff,0 0 22px rgba(255,102,255,0.08) }
  .theme-dark .stat.score{ color:#ffe58a; background:transparent }
  .theme-dark .stat.redButt{ color:#ff9aa2; background:transparent }
  .theme-dark .stat.total{ color:#b9f; background:transparent }

  /* RWD：平板以下改為單欄堆疊；按鈕可點不重疊 */
  @media (max-width: 900px){
    .layout{ grid-template-columns: 1fr }
    .btnRow{ position: relative; z-index: 5 }
  }
</style>
</head>
<body>
  <!-- 模式選擇 -->
  <div id="modeSelectOverlay" role="dialog" aria-modal="true">
    <div class="modeBox">
      <div class="modeItem modeLight">
        <h2>可愛亮色風（一般模式）</h2>
        <p>懲罰 5~50，下次加分翻倍＆護盾可能出現；第一次不會出減半/歸零。</p>
        <button class="modeBtn modeBtnLight" id="chooseNormal">進入一般模式</button>
      </div>
      <div class="modeItem modeDark">
        <h2 style="color:#9feaff">酷炫螢光風（困難模式）</h2>
        <p style="color:#cfeeff">懲罰 20~80，無護盾/無加倍；減半/歸零機率更高（首抽不會）。</p>
        <button class="modeBtn modeBtnDark" id="chooseHard">進入困難模式</button>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="app theme-light" id="app">
    <div class="topbar">
      <div class="title" id="title">Spank Game</div>
      <div class="controls">
        <label for="modeSelect">模式</label>
        <select id="modeSelect" aria-label="切換模式">
          <option value="normal">一般（可愛風）</option>
          <option value="hard">困難（酷炫風）</option>
        </select>
        <button id="drawBtn">抽 籤</button>
        <button id="stopBtn" disabled>停止</button>
        <button id="resetBtn">重新開始</button>
      </div>
    </div>

    <div class="layout">
      <!-- 左：結果 + 按鈕 + 狀態 -->
      <div class="leftCol">
        <div class="stats">
          <div class="stat score">分數：<span id="score">0</span></div>
          <div class="stat redButt">紅屁屁值：<span id="redButt">5</span></div>
          <div class="stat total">總挨打次數：<span id="totalHits">0</span></div>
        </div>

        <div class="resultCard">
          <div id="result">請先選擇模式，或直接開始抽籤！</div>
        </div>

        <div class="btnRow">
          <button id="drawBtn2">抽 籤</button>
          <button id="stopBtn2" disabled>停止</button>
          <button id="resetBtn2">重新開始</button>
        </div>
      </div>

      <!-- 右：說明 + 歷史 -->
      <div class="rightCol">
        <div class="card">
          <h3>遊戲說明</h3>
          <ul style="margin:0; padding-left: 18px; line-height:1.6">
            <li>抽籤決定事件。</li>
            <li>懲罰籤：只計入「總挨打」，不加分；若有護盾（僅一般）則免除。</li>
            <li>加分籤：分數上升；分數 ≥ 100 結束並顯示總挨打。</li>
            <li>特殊：分數減半、分數歸零、紅屁屁 ±1、下一輪懲罰 ×3、護盾（一般）、下次加分翻倍（一般）。</li>
            <li>兩種模式首抽都不出分數減半 / 歸零。</li>
          </ul>
        </div>

        <div class="card">
          <h3>歷史紀錄</h3>
          <div id="history" aria-live="polite" aria-label="抽籤歷史紀錄"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* 狀態與元素 */
const overlay = document.getElementById('modeSelectOverlay');
const chooseNormal = document.getElementById('chooseNormal');
const chooseHard   = document.getElementById('chooseHard');

const app = document.getElementById('app');
const titleEl = document.getElementById('title');
const modeSelect = document.getElementById('modeSelect');
const resultEl = document.getElementById('result');
const historyEl = document.getElementById('history');
const scoreEl = document.getElementById('score');
const redButtEl = document.getElementById('redButt');
const totalHitsEl = document.getElementById('totalHits');

/* 兩組按鈕（上排、下排都能操作） */
const drawBtn  = document.getElementById('drawBtn');
const stopBtn  = document.getElementById('stopBtn');
const resetBtn = document.getElementById('resetBtn');
const drawBtn2  = document.getElementById('drawBtn2');
const stopBtn2  = document.getElementById('stopBtn2');
const resetBtn2 = document.getElementById('resetBtn2');

let mode = 'normal';
let score = 0;
let redButt = 5;
let totalHits = 0;
let drawCount = 0;
let gameStarted = false;

let rolling = false;
let rollTimer = null;
let rollStep = 0;
let rollMax = 0;

let nextTriple = false;
let shieldActive = false;
let luckyDouble = false;

const tools = ["巴掌","戒尺","浴刷","小紅","小綠","塑膠棍","小黑棍","藤條","木板"];

/* 聲音（共用 AudioContext） */
function audioCtx(){
  if(!window.__spankCtx){ window.__spankCtx = new (window.AudioContext||window.webkitAudioContext)(); }
  return window.__spankCtx;
}
function playClick(){
  const ctx=audioCtx(); const o=ctx.createOscillator(); const g=ctx.createGain();
  o.type='square'; o.frequency.value=820; g.gain.value=0.04;
  o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.04);
}
function playDing(){
  const ctx=audioCtx(); const o=ctx.createOscillator(); const g=ctx.createGain();
  o.type='sine';
  o.frequency.setValueAtTime(1100,ctx.currentTime);
  o.frequency.exponentialRampToValueAtTime(1900,ctx.currentTime+0.26);
  g.gain.setValueAtTime(0.12,ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.28);
  o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.28);
}

/* 小工具 */
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function appendHistory(txt){
  const d = document.createElement('div');
  d.className = 'history-item';
  d.textContent = txt;
  historyEl.prepend(d);
  while(historyEl.children.length > 300){ historyEl.removeChild(historyEl.lastChild); }
}
function renderStats(){
  scoreEl.textContent = score;
  redButtEl.textContent = redButt;
  totalHitsEl.textContent = totalHits;
}

/* 模式與主題 */
function applyTheme(m){
  mode = m; modeSelect.value = m;
  if(m === 'normal'){
    app.classList.remove('theme-dark'); app.classList.add('theme-light');
    titleEl.classList.remove('neon-h1'); document.body.style.background = 'var(--light-bg1)';
  }else{
    app.classList.remove('theme-light'); app.classList.add('theme-dark');
    titleEl.classList.add('neon-h1'); document.body.style.background = 'linear-gradient(180deg,#041018,#031018)';
  }
  resultEl.textContent = '模式已切換，準備開始！';
}

/* 入口選單 */
chooseNormal.addEventListener('click', ()=>{ overlay.style.display='none'; applyTheme('normal'); });
chooseHard.addEventListener('click',   ()=>{ overlay.style.display='none'; applyTheme('hard'); });
modeSelect.addEventListener('change', e => applyTheme(e.target.value));

/* 各模式參數 */
function getParams(isFirst){
  let p = {};
  if(mode==='normal'){
    p.penMin=5;  p.penMax=50;
    p.gainMin=5; p.gainMax=20;

    p.gainProb=0.36;  p.penaltyProb=0.30;
    p.halfProb=isFirst?0:0.12;
    p.zeroProb=isFirst?0:0.06;

    p.specialProb=0.06; p.luckyProb=(drawCount>=5)?0.01:0;
    p.shieldProb=(drawCount>=5)?0.015:0;

    p.smallPenaltyBoostProb=0.015;
    p.doublePenaltyProb=0.005;
  }else{ // hard
    p.penMin=20; p.penMax=80;
    p.gainMin=3; p.gainMax=15;

    p.gainProb=0.30; p.penaltyProb=0.40;
    p.halfProb=isFirst?0:0.20;
    p.zeroProb=isFirst?0:0.12;

    p.specialProb=0.08; p.luckyProb=(drawCount>=5)?0.008:0;
    p.shieldProb=0;

    p.smallPenaltyBoostProb=0.02;
    p.doublePenaltyProb=0.01;
  }
  return p;
}

/* 抽籤動畫（漸慢） */
function startRollAnimation(){
  if(rolling) return;
  rolling = true;
  setBtns(true);
  rollStep = 0; rollMax = randInt(18,28);
  const base=50;

  function tick(){
    const tool = tools[randInt(0,tools.length-1)];
    const hits = randInt(mode==='normal'?5:20, mode==='normal'?50:80);
    resultEl.textContent = `${tool} ${hits} 下`;
    playClick();
    rollStep++;
    if(rollStep > rollMax){ if(rollTimer){clearTimeout(rollTimer)} finalizeDraw(); return; }
    const next = base + Math.floor(rollStep*rollStep*0.8);
    rollTimer = setTimeout(tick, next);
  }
  tick();
}

/* 抽籤結算 */
function finalizeDraw(){
  if(rollTimer){ clearTimeout(rollTimer); rollTimer=null; }
  const isFirst = !gameStarted;
  drawCount++; gameStarted = true;

  const p = getParams(isFirst);
  const rnd = Math.random();

  const gainUpper = p.gainProb;
  const penaltyUpper = gainUpper + p.penaltyProb;
  const halfUpper = penaltyUpper + p.halfProb;
  const zeroUpper = halfUpper + p.zeroProb;
  const specialUpper = zeroUpper + p.specialProb;
  const luckyUpper = specialUpper + p.luckyProb;
  const shieldUpper = luckyUpper + p.shieldProb;

  let msg='';

  if(rnd < gainUpper){
    let pts = randInt(p.gainMin, p.gainMax);
    if(luckyDouble){ pts*=2; luckyDouble=false; msg=`🎉 幸運加倍！加分 ${pts} 分`; }
    else msg=`加分 ${pts} 分`;
    score += pts;
    playDing();
  }
  else if(rnd < penaltyUpper){
    if(shieldActive){
      msg='🛡️ 護盾生效，懲罰免除！'; shieldActive=false; playDing();
    }else{
      let times = randInt(p.penMin,p.penMax);
      if(Math.random()<p.doublePenaltyProb){ times*=2; msg='雙重懲罰！'; }
      else if(Math.random()<p.smallPenaltyBoostProb){ const ex=randInt(10,20); times+=ex; msg=`懲罰次數增加 ${ex} 下！`; }
      if(nextTriple){ times*=3; nextTriple=false; msg = (msg?msg+' ':'')+'（特效：次數 ×3）'; }
      const tool = tools[randInt(0,tools.length-1)];
      msg = `${tool} ${times} 下` + (msg?(' · '+msg):'');
      totalHits += times; redButt += 1; playDing();
    }
  }
  else if(rnd < halfUpper){
    score = Math.floor(score/2); msg='💔 事件：分數減半！'; playDing();
  }
  else if(rnd < zeroUpper){
    score = 0; msg='💀 事件：分數歸零！'; playDing();
  }
  else if(rnd < specialUpper){
    const specials=[];
    specials.push({k:'nextTriple',w:1},{k:'redPlus',w:1},{k:'redMinus',w:1});
    if(mode==='normal') specials.push({k:'shield',w:1},{k:'scoreDouble',w:1});
    let sum=specials.reduce((s,it)=>s+it.w,0);
    let r=Math.random()*sum, pick=specials.find(it=>{r-=it.w; return r<=0;}).k;

    if(pick==='nextTriple'){ nextTriple=true; msg='🌟 特殊事件：下一輪懲罰次數 ×3！'; }
    else if(pick==='shield'){ shieldActive=true; msg='🛡️ 特殊事件：獲得護盾！'; }
    else if(pick==='redPlus'){ redButt+=1; msg='🔺 紅屁屁值 +1'; }
    else if(pick==='redMinus'){ redButt=Math.max(0, redButt-1); msg='🔻 紅屁屁值 -1'; }
    else if(pick==='scoreDouble'){ luckyDouble=true; msg='🍀 特殊事件：下次加分翻倍！'; }
    playDing();
  }
  else if(rnd < luckyUpper){
    luckyDouble=true; msg='🍀 幸運事件：下次加分翻倍！'; playDing();
  }
  else if(rnd < shieldUpper){
    if(mode==='normal'){ shieldActive=true; msg='🛡️ 護盾事件：下一次懲罰免疫！'; playDing(); }
    else msg='（無事件）';
  }else{
    msg='（無事件）';
  }

  renderStats();
  resultEl.innerHTML = `<span class="pop">${msg}</span>`;
  appendHistory(`${msg}（分數：${score}，紅屁屁：${redButt}）`);

  if(score >= 100){
    resultEl.textContent = `懲罰結束！總共挨打 ${totalHits} 下！🎉`;
    appendHistory(`*** 懲罰結束：總共挨打 ${totalHits} 下 ***`);
    rolling=false; setBtns(false,true);
    if(mode==='hard'){ resultEl.classList.add('neon-result'); }
    return;
  }

  rolling=false; setBtns(false,false);
}

/* 控制按鈕狀態（兩組同步） */
function setBtns(isRolling, finished=false){
  const d = !!isRolling;
  const f = !!finished;
  [drawBtn,drawBtn2].forEach(b=> b.disabled = d || f);
  [stopBtn,stopBtn2].forEach(b=> b.disabled = !d || f);
  [resetBtn,resetBtn2].forEach(b=> b.disabled = false);
}

/* 綁定按鈕（上排與下排都能操作） */
function onDraw(){ if(!rolling) startRollAnimation(); }
function onStop(){
  if(!rolling) return;
  if(rollTimer){ clearTimeout(rollTimer); rollTimer=null; }
  finalizeDraw();
}
function onReset(){
  if(rollTimer){ clearTimeout(rollTimer); rollTimer=null; }
  rolling=false; setBtns(false,false);
  score=0; redButt=5; totalHits=0; drawCount=0; gameStarted=false;
  nextTriple=false; shieldActive=false; luckyDouble=false;
  historyEl.innerHTML=''; resultEl.textContent='已重新開始（分數與紀錄已重置）';
  renderStats();
}
[drawBtn,drawBtn2].forEach(b=> b.addEventListener('click', onDraw));
[stopBtn,stopBtn2].forEach(b=> b.addEventListener('click', onStop));
[resetBtn,resetBtn2].forEach(b=> b.addEventListener('click', onReset));

/* 初始化 */
renderStats(); setBtns(false,false);
</script>
</body>
</html>
