<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<title>Spank Game â€” å¯æ„› / é…·ç‚«è¢å…‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>

/* æ•´é«”æœ€å¤§å¯¬åº¦èˆ‡ç½®ä¸­ */
.layout {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  flex-wrap: wrap;
}

/* å·¦å³æ¬„æ¯”ä¾‹ */
.left-panel {
  flex: 0 0 60%;
  max-width: 60%;
}
.right-panel {
  flex: 0 0 40%;
  max-width: 40%;
}

/* æŠ½ç±¤çµæœå€å¡ŠåŠ å¤§èˆ‡é–“è· */
#result {
  min-height: 120px;
  margin-bottom: 15px;
}

/* æ­·å²ç´€éŒ„é«˜åº¦é™åˆ¶æ›´å°ï¼Œé˜²æ­¢æ“ å£“ */
#historyList {
  max-height: 12vh;
  overflow-y: auto;
}

/* æ‰‹æ©Ÿç‰ˆæ¢å¾©æ»¿ç‰ˆé¡¯ç¤º */
@media (max-width: 768px) {
  .left-panel, .right-panel {
    flex: 1 1 100%;
    max-width: 100%;
  }
}


/* å„ªåŒ–æŒ‰éˆ•å¤–è§€èˆ‡é–“è· */
.buttons button {
  padding: 12px 20px;
  font-size: 1.1em;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;
}

/* æŒ‰éˆ•é¡è‰²å€åˆ† */
#drawBtn {
  background-color: #ff85a2;
  color: white;
}
#stopBtn {
  background-color: #f9d56e;
  color: black;
}
#resetBtn {
  background-color: #9be3de;
  color: black;
}

/* hover æ•ˆæœ */
.buttons button:hover {
  transform: scale(1.05);
  filter: brightness(1.1);
}

/* disabled ç‹€æ…‹ */
.buttons button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}


/* å·¦æ¬„æ”¹ç‚ºå‚ç›´æ’åˆ— */
.left-panel {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

/* æŠ½ç±¤çµæœå­—é«”è‡ªé©æ‡‰å¤§å° */
#result {
  font-size: clamp(1.2em, 2vw, 1.8em);
  padding: 15px;
}

/* æŒ‰éˆ•å€è‡ªå‹•æ›è¡Œä¸”ä¿æŒé–“è· */
.buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
}

/* å³æ¬„å›ºå®šå¯¬åº¦ï¼Œé˜²æ­¢æ“ å£“å·¦æ¬„ */
.right-panel {
  flex: 1 1 300px;
  min-width: 300px;
  max-width: 100%;
  overflow-y: auto;
  overflow-x: hidden;
  word-break: break-word;
}

/* æ¡Œæ©Ÿæ¨¡å¼ç¢ºä¿å·¦å³ä¸¦åˆ— */
.layout {
  align-items: flex-start;
}

/* æ‰‹æ©Ÿç‰ˆä¸Šä¸‹æ’åˆ— */
@media (max-width: 768px) {
  .left-panel, .right-panel {
    flex: 1 1 100%;
    max-width: 100%;
    min-width: unset;
  }
}


/* èª¿æ•´ layout å°é½Šï¼Œé¿å…å‚ç›´ç½®ä¸­å°è‡´è·‘ç‰ˆ */
.layout {
  align-items: flex-start;
}

/* å·¦æ¬„ï¼šå›ºå®šæœ€å¤§å¯¬åº¦ï¼Œå…è¨±ç¸®å° */
.left-panel {
  flex: 1 1 500px;
  max-width: 500px;
  min-width: 300px;
}

/* æŠ½ç±¤çµæœå­—é«”å¤§å°è‡ªé©æ‡‰ */
#result {
  font-size: clamp(1.2em, 2vw, 1.8em);
}

/* å³æ¬„ï¼šå›ºå®šæœ€å°å¯¬åº¦ï¼Œé˜²æ­¢è¢«æ“ å£“ï¼Œè¶…å‡ºæ›è¡Œ */
.right-panel {
  flex: 1 1 300px;
  min-width: 300px;
  max-width: 100%;
  overflow-x: hidden;
  word-break: break-word;
}

/* æ‰‹æ©Ÿç‰ˆä»ç„¶ä¸Šä¸‹ä½ˆå±€ */
@media (max-width: 768px) {
  .left-panel, .right-panel {
    flex: 1 1 100%;
    max-width: 100%;
    min-width: unset;
  }
}


/* å›ºå®šå·¦å³æ¬„å¯¬åº¦æ¯”ä¾‹ */
.left-panel {
  flex: 0 0 500px; /* å›ºå®šå¯¬åº¦ */
  max-width: 500px;
}
.right-panel {
  flex: 1;
  min-width: 300px;
}

/* ä¿æŒæ‰‹æ©Ÿç‰ˆä¸Šä¸‹ä½ˆå±€ */
@media (max-width: 768px) {
  .left-panel, .right-panel {
    flex: 1 1 100%;
    max-width: 100%;
  }
}


/* æŠ½ç±¤çµæœå¡ç‰‡æ¨£å¼ */
#result {
  background: linear-gradient(135deg, #fff5f5, #ffe0e0);
  border: 2px solid #ff8080;
  border-radius: 12px;
  padding: 20px;
  font-size: 1.8em;
  font-weight: bold;
  text-align: center;
  color: #d63333;
  margin-bottom: 20px;
  box-shadow: 0 4px 12px rgba(255,128,128,0.3);
}


/* å·¦å³åˆ†æ¬„ä½ˆå±€ */
.layout {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
}
.left-panel {
  flex: 1 1 50%;
  min-width: 280px;
}
.right-panel {
  flex: 1 1 40%;
  min-width: 250px;
}

/* æ‰‹æ©Ÿç‰ˆä¸Šä¸‹ä½ˆå±€ */
@media (max-width: 768px) {
  .layout {
    flex-direction: column;
  }
  .left-panel, .right-panel {
    flex: 1 1 100%;
    min-width: unset;
  }
}

/* èª¿æ•´æ­·å²ç´€éŒ„æ¡†é«˜åº¦ */
#history {
  max-height: 15vh !important;
  overflow-y: auto !important;
}

/* æ‰‹æ©Ÿæ¨¡å¼æŒ‰éˆ•å€é–“è· */
@media (max-width: 768px) {
  .buttons {
    margin-top: 10px;
    margin-bottom: 15px;
  }
}


@media (max-width: 768px) {
  .buttons {
    margin-top: 10px;
    margin-bottom: 15px;
  }
}


/* å‚ç›´ç½®ä¸­æ•´é«”ç‰ˆé¢ï¼ˆåƒ…åœ¨å…§å®¹é«˜åº¦å°æ–¼è¢å¹•æ™‚ï¼‰ */
html, body {
  height: 100%;
}
body.center-layout {
  display: flex;
  flex-direction: column;
  justify-content: center;
}

/* æ­·å²ç´€éŒ„æ¡†æ›´å°ï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰ */
@media (max-width: 768px) {
  #history {
    max-height: 15vh !important;
    overflow-y: auto !important;
  }
}


/* æŒ‰éˆ•å€å›ºå®šåœ¨ç•«é¢æ­£ä¸­å¤® */
.buttons {
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
  margin: 0 auto;
}
@media (max-width: 768px) {
  .buttons {
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 400px;
  }
  .buttons button {
    flex: 1 1 100%;
    min-height: 50px;
    font-size: 1.2em;
  }
}


/* æ­·å²ç´€éŒ„å›ºå®šé«˜åº¦ï¼Œé¿å…æŒ‰éˆ•è¢«æ“ è·‘ */
@media (max-width: 768px) {
  #history {
    max-height: 18vh !important; /* é™åˆ¶æ­·å²ç´€éŒ„é«˜åº¦ç‚ºè¢å¹•çš„25% */
    overflow-y: auto !important; /* è¶…å‡ºæ™‚å…§éƒ¨æ»¾å‹• */
    padding-bottom: 5px;
  }
  #historyList {
    margin: 0;
    padding: 0;
    list-style: none;
  }
  #historyList li {
    word-break: break-word;
    padding: 4px 0;
    border-bottom: 1px solid #eee;
  }
}


/* æ‰‹æ©Ÿé˜²è·‘ç‰ˆæŒ‰éˆ•å¸ƒå±€ */
@media (max-width: 768px) {
  .buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    width: 100%;
    max-width: 400px;
    margin: 10px auto 0 auto;
    justify-content: center;
    position: relative;
    z-index: 1000;
  }
  .buttons button {
    flex: 1 1 100%;
    font-size: 1.2em;
    min-height: 50px;
    padding: 12px;
    border-radius: 10px;
  }
  #result {
    margin-bottom: 10px;
  }
  #history {
    max-height: 18vh;
    overflow-y: auto;
  }
}


/* æ‰‹æ©Ÿå®Œå…¨ç©©å®šç‰ˆ RWD */
@media (max-width: 768px) {
  body { padding: 10px; font-size: 14px; }
  h1 { font-size: 2em; text-align: center; }
  .status { 
    flex-direction: column; 
    gap: 10px; 
    font-size: 1em; 
    align-items: center; 
  }
  /* æ¨¡å¼é¸æ“‡èˆ‡ç‹€æ…‹å€å¡Šç½®ä¸­ */
  select { font-size: 1.1em; padding: 8px; max-width: 100%; }
  
  /* æŒ‰éˆ•å€åŸŸç¢ºä¿å¯é»æ“Šä¸”ä¸é‡ç–Š */
  .buttons { 
    display: flex; 
    flex-direction: column; 
    gap: 10px; 
    width: 100%; 
    max-width: 320px; 
    margin: 0 auto; 
    position: relative;
    z-index: 1000;
  }
  button { 
    font-size: 1.2em; 
    padding: 14px; 
    min-height: 50px; 
    width: 100%; 
    border-radius: 10px;
  }
  /* æ­·å²ç´€éŒ„é«˜åº¦é™åˆ¶ */
  #history { 
    max-height: 18vh; 
    overflow-y: auto; 
    font-size: 0.9em; 
    position: relative; 
    z-index: 1;
  }
  /* æŠ½ç±¤çµæœé¡¯ç¤ºå€å¡Š */
  #result { 
    font-size: 1.4em; 
    padding: 10px; 
    word-break: break-word; 
    text-align: center; 
    position: relative; 
    z-index: 1;
  }
}
@media (max-width: 480px) {
  h1 { font-size: 1.6em; }
  .status { font-size: 0.9em; }
  button { font-size: 1.1em; padding: 12px; min-height: 46px; }
  #result { font-size: 1.2em; }
}


/* æ‰‹æ©Ÿå…¨è¢å¹•å„ªåŒ– + æŒ‰éˆ•å¯é»æ“Šä¿è­‰ */
@media (max-width: 768px) {
  body { padding: 10px; font-size: 14px; }
  h1 { font-size: 2em; text-align: center; }
  .status { flex-direction: column; gap: 10px; font-size: 1em; align-items: center; }
  .buttons { 
    display: flex; 
    flex-direction: column; 
    gap: 10px; 
    width: 100%; 
    max-width: 320px; 
    margin: 0 auto; 
    position: relative;
    z-index: 1000; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤å¯é» */
  }
  button { font-size: 1.2em; padding: 14px; min-height: 48px; width: 100%; }
  #history { max-height: 18vh; overflow-y: auto; font-size: 0.9em; position: relative; z-index: 1; }
  #result { font-size: 1.4em; padding: 10px; word-break: break-word; text-align: center; position: relative; z-index: 1; }
}
@media (max-width: 480px) {
  h1 { font-size: 1.6em; }
  .status { font-size: 0.9em; }
  button { font-size: 1.1em; padding: 12px; min-height: 46px; }
  #result { font-size: 1.2em; }
}

  :root{
    --glass: rgba(0,0,0,0.08);
    --light-bg1:#fff8fb; --light-bg2:#fff;
    --accent:#ff6b9a;
  }
  html,body{height:100%;margin:0;font-family:"Microsoft JhengHei",sans-serif}
  body{display:flex;align-items:center;justify-content:center;padding:18px;background:var(--light-bg1)}
  .app{width:100%;max-width:980px;border-radius:12px;overflow:hidden;box-shadow:0 14px 40px rgba(0,0,0,0.12)}
  .panel{padding:0;background:linear-gradient(180deg,var(--light-bg2),#fff)}

  /* Mode overlay */
  #modeSelectOverlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,0.28),rgba(0,0,0,0.45));z-index:30}
  .modeBox{background:linear-gradient(180deg,#fff,#fff8fb);padding:20px;border-radius:12px;width:min(900px,94%);display:flex;gap:18px;flex-wrap:wrap;box-shadow:0 18px 60px rgba(0,0,0,0.4)}
  .modeItem{flex:1;min-width:260px;padding:18px;border-radius:10px;text-align:center}
  .modeLight{background:linear-gradient(180deg,#fff0f5,#ffeef2);border:1px solid #ffd6e8}
  .modeDark{background:linear-gradient(180deg,#061018,#071522);color:#e6f7ff;border:1px solid rgba(255,255,255,0.04)}
  .modeBtn{margin-top:12px;padding:10px 18px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
  .modeBtnLight{background:#ff6b9a;color:#fff}
  .modeBtnDark{background:#00d7ff;color:#022}

  /* topbar */
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:transparent}
  .title{font-size:1.4rem;font-weight:800}
  .controls{display:flex;gap:8px;align-items:center}
  select,button{padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
  /* main layout */
  .main{display:flex;gap:14px;padding:18px}
  .left{flex:1;background:rgba(255,255,255,0.92);border-radius:10px;padding:14px;box-shadow:0 6px 18px var(--glass)}
  .right{width:320px;min-width:260px;background:rgba(255,255,255,0.92);border-radius:10px;padding:14px;box-shadow:0 6px 18px var(--glass)}

  .stats{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .stat{padding:8px 10px;border-radius:8px;font-weight:700}
  .stat.score{background:linear-gradient(180deg,#fff9db,#fff2c2);color:#a65a00}
  .stat.redButt{background:linear-gradient(180deg,#ffe9e9,#ffdede);color:#b33a3a}
  .stat.total{background:linear-gradient(180deg,#eaf7ff,#d9f0ff);color:#0b6d91}

  #result{height:88px;display:flex;align-items:center;justify-content:center;font-size:1.15rem;font-weight:700;margin-top:12px;border-radius:10px;background:linear-gradient(180deg,#ffffff,#fffaf7);box-shadow:inset 0 2px 6px rgba(0,0,0,0.03)}

  #history{margin-top:14px;max-height:420px;overflow:auto;padding:8px;background:rgba(255,255,255,0.95);border-radius:8px}
  .history-item{padding:8px;border-bottom:1px solid #f1f1f1;font-size:0.95rem;color:#333}
  .history-item:last-child{border-bottom:none}

  /* buttons */
  #drawBtn{background:linear-gradient(90deg,#ff6b9a,#ff85a2);color:#fff;font-weight:800;padding:10px 16px;border-radius:10px;font-size:1rem}
  #stopBtn{background:#ffb86b;color:#000;padding:8px 12px}
  #resetBtn{background:#bdbdbd;color:#021;padding:8px 12px}
  #drawBtn:disabled,#stopBtn:disabled{opacity:.5;cursor:not-allowed;transform:none}

  /* pop animation */
  .pop{animation:pop 0.55s ease forwards;color:var(--accent)}
  @keyframes pop{0%{transform:scale(.6);opacity:0}70%{transform:scale(1.12);opacity:1}100%{transform:scale(1)}}

  /* dark / neon theme */
  .theme-dark body, .theme-dark { background: linear-gradient(180deg,#041018,#031018) }
  .theme-dark .panel{background:linear-gradient(180deg,#071322,#041018); color:#e8f6ff}
  .theme-dark .left,.theme-dark .right{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); color:#dbeefe}
  .theme-dark .history-item{color:#cbd5e1;border-bottom:1px solid rgba(255,255,255,0.02)}
  .theme-dark #result{background:linear-gradient(180deg,#071322,#041018); box-shadow: inset 0 2px 8px rgba(0,0,0,0.6)}
  .theme-dark .stat.score{color:#ffe58a;background:transparent}
  .theme-dark .stat.redButt{color:#ff9aa2;background:transparent}
  .theme-dark .stat.total{color:#b9f;background:transparent}

  /* neon text & buttons for neon dark mode */
  .neon-h1{ color:#00ffff; text-shadow:0 0 8px #00ffff,0 0 20px rgba(0,255,255,0.08); }
  .neon-result{ color:#ff66ff; text-shadow:0 0 10px #ff66ff,0 0 22px rgba(255,102,255,0.06) }
  .neon-stat{ text-shadow:0 0 6px rgba(255,255,255,0.03) }

  .neon-btn {
    box-shadow: 0 8px 30px rgba(0,215,255,0.08), inset 0 -2px 10px rgba(0,0,0,0.15);
    border: 1px solid rgba(0,215,255,0.15);
    transition: transform .08s, box-shadow .12s;
  }
  .neon-btn:hover { transform:translateY(-3px); box-shadow:0 14px 40px rgba(0,215,255,0.12) }

  /* neon colors for important text */
  .neon-score{ color:#ffea00; text-shadow:0 0 8px rgba(255,234,0,0.4) }
  .neon-redButt{ color:#ff9aa2; text-shadow:0 0 8px rgba(255,154,162,0.18) }

  @media (max-width:900px){ .main{flex-direction:column} .right{width:100%} }
</style>
</head>
<body>
<div class="layout"><div class="left-panel" class=\"center-layout\">
  <!-- mode choose overlay -->
  <div id="modeSelectOverlay" role="dialog" aria-modal="true">
    <div class="modeBox">
      <div class="modeItem modeLight">
        <h2>å¯æ„›äº®è‰²é¢¨ â€” æ–°æ‰‹æ¨¡å¼</h2>
        <p>æ‡²ç½°æ¬¡æ•¸ 5 ~ 50ï¼Œæœƒå‡ºè­·ç›¾ã€æœƒå‡ºåˆ†æ•¸åŠ å€ï¼Œç¬¬ä¸€æ¬¡ä¸æœƒå‡ºåˆ†æ•¸æ¸›åŠ/æ­¸é›¶</p>
        <button class="modeBtn modeBtnLight" id="chooseNormal" data-mode="normal">é¸ä¸€èˆ¬æ¨¡å¼</button>
      </div>
      <div class="modeItem modeDark">
        <h2 style="color:#9feaff">é…·ç‚«è¢å…‰é¢¨ â€” è¨æ‰“æ¨¡å¼</h2>
        <p style="color:#cfeeff">æ‡²ç½°æ¬¡æ•¸ 20 ~ 80ï¼Œç„¡è­·ç›¾ï¼Œæ¸›åŠ/æ­¸é›¶æ©Ÿç‡è¼ƒé«˜ï¼Œç¬¬ä¸€æ¬¡ä¸æœƒå‡ºæ¸›åŠ/æ­¸é›¶</p>
        <button class="modeBtn modeBtnDark" id="chooseHard" data-mode="hard">é¸å›°é›£æ¨¡å¼</button>
      </div>
    </div>
  </div>

  <div class="app panel theme-light" id="app">
    <div class="topbar">
      <div class="title">Spank Game</div>
      <div class="controls">
        <label for="modeSelect">æ¨¡å¼</label>
        <select id="modeSelect" aria-label="åˆ‡æ›æ¨¡å¼">
          <option value="normal">ä¸€èˆ¬</option>
          <option value="hard">å›°é›£</option>
        </select>
        <button id="drawBtn">æŠ½ ç±¤</button>
        <button id="stopBtn" disabled>åœæ­¢</button>
        <button id="resetBtn">é‡æ–°é–‹å§‹</button>
      </div>
    </div>

    <div class="main">
      <div class="left">
        <div class="stats">
          <div class="stat score">åˆ†æ•¸ï¼š<span id="score">0</span></div>
          <div class="stat redButt">ç´…å±å±å€¼ï¼š<span id="redButt">5</span></div>
          <div class="stat total">ç¸½æŒ¨æ‰“æ¬¡æ•¸ï¼š<span id="totalHits">0</span></div>
        </div>

        <div id="result">è«‹å…ˆé¸æ“‡æ¨¡å¼ï¼ˆæˆ–æŒ‰é–‹å§‹æŠ½ç±¤ï¼‰</div>

        </div><div class="right-panel"><div id="history" aria-live="polite" aria-label="æŠ½ç±¤æ­·å²ç´€éŒ„"></div>
      </div>

      <div class="right">
        <h3>éŠæˆ²èªªæ˜</h3>
        <ul style="text-align:left;padding-left:18px">
          <li>æŠ½ç±¤æ±ºå®šæ‡²ç½°ã€‚</li>
          <li>æ‡²ç½°ç±¤ï¼šåªè¨ˆå…¥ç¸½æŒ¨æ‰“ï¼ˆä¸åŠ åˆ†ï¼‰ï¼›è‹¥æœ‰è­·ç›¾å‰‡å…é™¤ã€‚</li>
          <li>åŠ åˆ†ç±¤ï¼šå¢åŠ åˆ†æ•¸ï¼ˆåˆ†æ•¸ â‰¥ 100 çµæŸéŠæˆ²ï¼‰ã€‚</li>
          <li>ç‰¹æ®Šäº‹ä»¶ï¼šåˆ†æ•¸æ¸›åŠã€åˆ†æ•¸æ­¸é›¶ã€ç´…å±å± Â±1ã€ä¸‹ä¸€è¼ªæ‡²ç½°Ã—3ã€è­·ç›¾ï¼ˆä¸€èˆ¬æ¨¡å¼ï¼‰ã€åˆ†æ•¸åŠ å€ï¼ˆä¸€èˆ¬æ¨¡å¼ï¼‰ã€‚</li>
          <li>ç¬¬ä¸€æ¬¡æŠ½ç±¤ä¸æœƒå‡ºç¾åˆ†æ•¸æ¸›åŠæˆ–æ­¸é›¶ã€‚</li>
        </ul>
      </div>
    </div>
  </div>

<script>
/* ------------------------------
   å…ƒä»¶èˆ‡ç‹€æ…‹
   ------------------------------ */
const overlay = document.getElementById('modeSelectOverlay');
const chooseNormal = document.getElementById('chooseNormal');
const chooseHard = document.getElementById('chooseHard');

const app = document.getElementById('app');
const modeSelect = document.getElementById('modeSelect');
const drawBtn = document.getElementById('drawBtn');
const stopBtn = document.getElementById('stopBtn');
const resetBtn = document.getElementById('resetBtn');
const resultEl = document.getElementById('result');
const historyEl = document.getElementById('history');
const scoreEl = document.getElementById('score');
const redButtEl = document.getElementById('redButt');
const totalHitsEl = document.getElementById('totalHits');

let mode = 'normal';
let score = 0;
let redButt = 5;
let totalHits = 0;
let drawCount = 0;
let gameStarted = false;

// rolling
let rolling = false;
let rollTimer = null;
let rollStep = 0;
let rollMax = 0;

// flags
let nextTriple = false;
let shieldActive = false;
let luckyDouble = false;

// tools
const tools = ["å·´æŒ","æˆ’å°º","æµ´åˆ·","å°ç´…","å°ç¶ ","å¡‘è† æ£","å°é»‘æ£","è—¤æ¢","æœ¨æ¿"];

/* ------------------------------
   éŸ³æ•ˆï¼ˆå…±ç”¨ AudioContextï¼‰
   ------------------------------ */
function audioCtx(){ if(!window.__spankCtx) window.__spankCtx = new (window.AudioContext || window.webkitAudioContext)(); return window.__spankCtx; }
function playClick(){ const ctx=audioCtx(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='square'; o.frequency.value=820; g.gain.value=0.04; o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.04); }
function playDing(){ const ctx=audioCtx(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.setValueAtTime(1100,ctx.currentTime); o.frequency.exponentialRampToValueAtTime(1900,ctx.currentTime+0.26); g.gain.setValueAtTime(0.12,ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.28); o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.28); }

/* ------------------------------
   UI helpers
   ------------------------------ */
function appendHistory(txt){
  const d = document.createElement('div');
  d.className = 'history-item';
  d.textContent = txt;
  historyEl.prepend(d);
  while(historyEl.children.length > 300) historyEl.removeChild(historyEl.lastChild);
}
function renderStats(){
  scoreEl.textContent = score;
  redButtEl.textContent = redButt;
  totalHitsEl.textContent = totalHits;
}

/* ------------------------------
   Random helper
   ------------------------------ */
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

/* ------------------------------
   Theme / Mode apply
   ------------------------------ */
function applyTheme(m){
  mode = m;
  modeSelect.value = m;
  if(m === 'normal'){
    app.classList.remove('theme-dark');
    app.classList.add('theme-light');
    app.querySelector('.title').classList.remove('neon-h1');
    // ensure light visuals
    document.body.style.background = 'var(--light-bg1)';
  } else {
    app.classList.remove('theme-light');
    app.classList.add('theme-dark');
    // neon styling: apply neon classes
    app.querySelector('.title').classList.add('neon-h1');
    document.body.style.background = 'linear-gradient(180deg,#041018,#031018)';
  }
  resultEl.textContent = 'æ¨¡å¼å·²åˆ‡æ›ï¼Œæº–å‚™é–‹å§‹éŠæˆ²ã€‚';
}

/* overlay buttons */
chooseNormal.addEventListener('click', ()=>{ overlay.style.display='none'; applyTheme('normal'); });
chooseHard.addEventListener('click', ()=>{ overlay.style.display='none'; applyTheme('hard'); });
modeSelect.addEventListener('change', e => applyTheme(e.target.value));

/* ------------------------------
   game params per mode
   ------------------------------ */
function getParams(isFirst){
  let p = {};
  if(mode === 'normal'){
    p.penMin = 5; p.penMax = 50; p.gainMin = 5; p.gainMax = 20;
    p.gainProb = 0.36; p.penaltyProb = 0.30;
    p.halfProb = isFirst?0:0.12; p.zeroProb = isFirst?0:0.06;
    p.specialProb = 0.06; p.luckyProb = (drawCount>=5)?0.01:0;
    p.shieldProb = (drawCount>=5)?0.015:0;
    p.smallPenaltyBoostProb = 0.015; p.doublePenaltyProb = 0.005;
  } else {
    p.penMin = 20; p.penMax = 80; p.gainMin = 3; p.gainMax = 15;
    p.gainProb = 0.30; p.penaltyProb = 0.40;
    p.halfProb = isFirst?0:0.20; p.zeroProb = isFirst?0:0.12;
    p.specialProb = 0.08; p.luckyProb = (drawCount>=5)?0.008:0;
    p.shieldProb = 0; p.smallPenaltyBoostProb = 0.02; p.doublePenaltyProb = 0.01;
  }
  return p;
}

/* ------------------------------
   roll animation (progressively slows)
   ------------------------------ */
function startRollAnimation(){
  if(rolling) return;
  rolling = true;
  drawBtn.disabled = true;
  stopBtn.disabled = false;
  rollStep = 0;
  rollMax = randInt(18,28);
  const baseSpeed = 50;

  function tick(){
    const tool = tools[randInt(0,tools.length-1)];
    const previewMin = (mode==='normal'?5:20);
    const previewMax = (mode==='normal'?50:80);
    const hitsPreview = randInt(previewMin, previewMax);
    resultEl.textContent = `${tool} ${hitsPreview} ä¸‹`;
    playClick();

    rollStep++;
    if(rollStep > rollMax){
      if(rollTimer){ clearTimeout(rollTimer); rollTimer = null; }
      finalizeDraw();
      return;
    }
    const nextDelay = baseSpeed + Math.floor(rollStep*rollStep * 0.8);
    rollTimer = setTimeout(tick, nextDelay);
  }
  tick();
}

/* ------------------------------
   finalizeDraw: æ ¸å¿ƒæ©Ÿç‡ / è¡Œç‚º
   ------------------------------ */
function finalizeDraw(){
  if(rollTimer){ clearTimeout(rollTimer); rollTimer = null; }
  const isFirst = !gameStarted;
  drawCount++;
  gameStarted = true;

  const p = getParams(isFirst);
  const rnd = Math.random();

  // boundaries
  const gainUpper = p.gainProb;
  const penaltyUpper = gainUpper + p.penaltyProb;
  const halfUpper = penaltyUpper + p.halfProb;
  const zeroUpper = halfUpper + p.zeroProb;
  const specialUpper = zeroUpper + p.specialProb;
  const luckyUpper = specialUpper + p.luckyProb;
  const shieldUpper = luckyUpper + p.shieldProb;

  let displayMsg = '';

  // GAIN (åŠ åˆ†ç±¤)
  if(rnd < gainUpper){
    let pts = randInt(p.gainMin, p.gainMax);
    if(luckyDouble){ pts *= 2; luckyDouble = false; displayMsg = `ğŸ‰ å¹¸é‹åŠ å€ï¼åŠ åˆ† ${pts} åˆ†`; }
    else displayMsg = `åŠ åˆ† ${pts} åˆ†`;
    score += pts;
    playDing();
  }
  // PENALTY (æ‡²ç½°ç±¤)
  else if(rnd < penaltyUpper){
    if(shieldActive){
      displayMsg = 'ğŸ›¡ï¸ è­·ç›¾ç”Ÿæ•ˆï¼Œæ‡²ç½°å…é™¤ï¼';
      shieldActive = false;
      playDing();
    } else {
      let times = randInt(p.penMin, p.penMax);
      // rare extra events
      if(Math.random() < p.doublePenaltyProb){
        times *= 2;
        displayMsg = `é›™é‡æ‡²ç½°ï¼`;
      } else if(Math.random() < p.smallPenaltyBoostProb){
        const extra = randInt(10,20);
        times += extra;
        displayMsg = `æ‡²ç½°æ¬¡æ•¸å¢åŠ  ${extra} ä¸‹ï¼`;
      } else {
        displayMsg = '';
      }
      if(nextTriple){
        times *= 3;
        nextTriple = false;
        displayMsg = (displayMsg?displayMsg + ' ':'') + 'ï¼ˆç‰¹æ•ˆï¼šæ¬¡æ•¸ Ã—3ï¼‰';
      }
      const toolIdx = randInt(0, tools.length-1);
      displayMsg = `${tools[toolIdx]} ${times} ä¸‹` + (displayMsg?(' Â· '+displayMsg):'');
      totalHits += times;
      redButt += 1;
      playDing();
    }
  }
  // HALF
  else if(rnd < halfUpper){
    score = Math.floor(score/2);
    displayMsg = 'ğŸ’” äº‹ä»¶ï¼šåˆ†æ•¸æ¸›åŠï¼';
    playDing();
  }
  // ZERO
  else if(rnd < zeroUpper){
    score = 0;
    displayMsg = 'ğŸ’€ äº‹ä»¶ï¼šåˆ†æ•¸æ­¸é›¶ï¼';
    playDing();
  }
  // SPECIAL
  else if(rnd < specialUpper){
    // choose special subtype
    const specials = [];
    specials.push({k:'nextTriple',w:1});
    specials.push({k:'redPlus',w:1});
    specials.push({k:'redMinus',w:1});
    if(mode==='normal') specials.push({k:'shield',w:1});
    if(mode==='normal') specials.push({k:'scoreDouble',w:1});
    let sumW = specials.reduce((s,it)=>s+it.w,0);
    let r = Math.random()*sumW;
    let pick = specials.find(it => { r -= it.w; return r <= 0; }).k;

    if(pick === 'nextTriple'){ nextTriple = true; displayMsg = 'ğŸŒŸ ç‰¹æ®Šäº‹ä»¶ï¼šä¸‹ä¸€è¼ªæ‡²ç½°æ¬¡æ•¸ Ã—3ï¼'; }
    else if(pick === 'shield'){ shieldActive = true; displayMsg = 'ğŸ›¡ï¸ ç‰¹æ®Šäº‹ä»¶ï¼šç²å¾—è­·ç›¾ï¼ˆä¸‹ä¸€æ¬¡æ‡²ç½°å…ç–«ï¼‰ï¼'; }
    else if(pick === 'redPlus'){ redButt += 1; displayMsg = 'ğŸ”º ç´…å±å±å€¼ +1'; }
    else if(pick === 'redMinus'){ redButt = Math.max(0, redButt - 1); displayMsg = 'ğŸ”» ç´…å±å±å€¼ -1'; }
    else if(pick === 'scoreDouble'){ luckyDouble = true; displayMsg = 'ğŸ€ ç‰¹æ®Šäº‹ä»¶ï¼šä¸‹æ¬¡åŠ åˆ†ç¿»å€ï¼'; }
    playDing();
  }
  // LUCKY
  else if(rnd < luckyUpper){
    luckyDouble = true;
    displayMsg = 'ğŸ€ å¹¸é‹äº‹ä»¶ï¼šä¸‹æ¬¡åŠ åˆ†ç¿»å€ï¼';
    playDing();
  }
  // SHIELD (rare)
  else if(rnd < shieldUpper){
    if(mode === 'normal'){ shieldActive = true; displayMsg = 'ğŸ›¡ï¸ è­·ç›¾äº‹ä»¶ï¼šä¸‹ä¸€æ¬¡æ‡²ç½°å…ç–«ï¼'; playDing(); }
    else displayMsg = 'ï¼ˆç„¡äº‹ä»¶ï¼‰';
  }
  else {
    displayMsg = 'ï¼ˆç„¡äº‹ä»¶ï¼‰';
  }

  if(isFirst) gameStarted = true;
  renderStats();

  // show & history
  resultEl.innerHTML = `<span class="pop">${displayMsg}</span>`;
  appendHistory(`${displayMsg}ï¼ˆåˆ†æ•¸ï¼š${score}ï¼Œç´…å±å±ï¼š${redButt}ï¼‰`);

  // check end
  if(score >= 100){
    resultEl.textContent = `æ‡²ç½°çµæŸï¼ç¸½å…±æŒ¨æ‰“ ${totalHits} ä¸‹ï¼ğŸ‰`;
    appendHistory(`*** æ‡²ç½°çµæŸï¼šç¸½å…±æŒ¨æ‰“ ${totalHits} ä¸‹ ***`);
    drawBtn.disabled = true; stopBtn.disabled = true; rolling = false;
    // apply neon styles in dark mode to highlight final
    if(mode === 'hard'){ resultEl.classList.add('neon-result'); }
    return;
  }

  // finish rolling state
  rolling = false; drawBtn.disabled = false; stopBtn.disabled = true;
}

/* ------------------------------
   controls: draw / stop / reset
   ------------------------------ */
drawBtn.addEventListener('click', ()=>{ if(!rolling) startRollAnimation(); });
stopBtn.addEventListener('click', ()=>{
  if(!rolling) return;
  if(rollTimer){ clearTimeout(rollTimer); rollTimer = null; }
  finalizeDraw();
});
resetBtn.addEventListener('click', ()=>{
  if(rollTimer){ clearTimeout(rollTimer); rollTimer = null; }
  rolling = false; drawBtn.disabled = false; stopBtn.disabled = true;
  score = 0; redButt = 5; totalHits = 0; drawCount = 0; gameStarted = false;
  nextTriple = false; shieldActive = false; luckyDouble = false;
  historyEl.innerHTML = ''; resultEl.textContent = 'å·²é‡æ–°é–‹å§‹ï¼ˆåˆ†æ•¸èˆ‡ç´€éŒ„å·²é‡ç½®ï¼‰';
  renderStats();
});

/* init */
renderStats(); stopBtn.disabled = true;
</script>
</body>
</html>
