<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Spank Game · 新手 / 討打 / 無限</title>
<style>
  :root{
    --cute-bg1:#fff0f5; --cute-bg2:#ffe4e1; --cute-accent:#ff69b4; --cute-btn:#ff85a2;
    --cool-bg1:#0b0b0e; --cool-bg2:#181a1f; --cool-fg:#fffbef; --cool-accent:#7ce7ff;
    --danger-bg1:#150606; --danger-bg2:#2b0006; --danger-fg:#ffeaea; --danger-accent:#ff4257;
    --card:#ffffff; --muted:#667; --ok:#2e7d32; --warn:#ef6c00; --danger:#e53935;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0}
  body.cute{background:linear-gradient(135deg,var(--cute-bg1),var(--cute-bg2)); color:#444; font-family:"Microsoft JhengHei", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;}
  body.cool{background:linear-gradient(135deg,var(--cool-bg1),var(--cool-bg2)); color:var(--cool-fg); font-family:"Microsoft JhengHei", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; text-shadow:0 0 6px rgba(0,0,0,.6)}
  body.danger{background:linear-gradient(135deg,var(--danger-bg1),var(--danger-bg2)); color:var(--danger-fg); font-family:"Microsoft JhengHei", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; text-shadow:0 0 6px rgba(0,0,0,.5)}
  .wrap{max-width:1400px; margin:0 auto; padding:18px}
  header{display:flex; flex-wrap:wrap; align-items:center; gap:12px; justify-content:space-between; margin-bottom:12px}
  .title{display:flex; align-items:center; gap:10px}
  .title h1{margin:0; font-size:clamp(22px,3.2vw,36px)}
  body.cute .title h1{color:var(--cute-accent); text-shadow:0 0 10px #ffb6c1}
  body.cool .title h1{color:#fff}
  body.danger .title h1{color:#fff}
  .controls-top{display:flex; flex-wrap:wrap; align-items:center; gap:12px}
  select, input[type="number"]{
    padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,.15); font-size:16px; min-width:160px;
    background:#fff; color:#333;
  }
  .grid{display:grid; grid-template-columns: 1.2fr 0.8fr; gap:16px}
  @media (max-width: 960px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card); border-radius:14px; padding:14px; box-shadow:0 6px 18px rgba(0,0,0,.08)}
  body.cool .card{background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); backdrop-filter: blur(4px)}
  body.danger .card{background:rgba(255,255,255,.08); border:1px solid rgba(255,118,118,.18); backdrop-filter: blur(4px)}
  .stats{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
  .stat{background:#fff; border-radius:10px; padding:8px 12px; font-weight:700; color:#123; box-shadow:0 4px 12px rgba(0,0,0,.06)}
  body.cool .stat, body.danger .stat{background:rgba(255,255,255,.15); color:#fff}
  .big-result{
    font-size:clamp(22px,3.6vw,36px); text-align:center; min-height:80px; display:flex; align-items:center; justify-content:center;
    background:linear-gradient(180deg,#fff,#f7fffb); border-radius:12px; padding:16px; margin:12px 0; color:#123;
  }
  body.cool .big-result, body.danger .big-result{background:rgba(255,255,255,.12); color:#fff}
  .btnrow{display:flex; flex-wrap:wrap; gap:10px; justify-content:center}
  button{
    border:none; border-radius:12px; padding:14px 16px; font-size:18px; font-weight:700; cursor:pointer;
    transition:transform .05s ease, box-shadow .2s ease;
  }
  button:active{transform:scale(.98)}
  #drawBtn{background:var(--cute-btn); color:#fff; box-shadow:0 10px 20px rgba(255,133,162,.35)}
  body.cool #drawBtn{background:#6ae3ff; color:#07242f; box-shadow:0 10px 20px rgba(106,227,255,.35)}
  body.danger #drawBtn{background:var(--danger-accent); color:#210207; box-shadow:0 10px 20px rgba(255,66,87,.35)}
  #endBtn{background:var(--danger); color:#fff}
  #resetBtn{background:#9be3de; color:#043b3a}
  .history{max-height:160px; overflow:auto; font-size:14px}
  .history h3{margin:0 0 8px 0; font-size:16px; text-align:center}
  #historyList{list-style:none; padding-left:0; margin:0}
  #historyList li{padding:8px 6px; border-bottom:1px solid rgba(0,0,0,.06)}
  body.cool #historyList li, body.danger #historyList li{border-color:rgba(255,255,255,.12)}
  .info p{margin:.5em 0; color:var(--muted)}
  body.cool .info p, body.danger .info p{color:#e8e8e8}
  .label{font-weight:700}
  .bad{color:var(--danger)} .good{color:var(--ok)} .warn{color:var(--warn)}

  .rolling{animation: pulse .5s ease-in-out infinite alternate}
  @keyframes pulse{from{transform:scale(1)} to{transform:scale(1.04)}}

  .two-col{display:grid; grid-template-columns: 1fr; gap:16px}
  @media (min-width: 960px){ .two-col{grid-template-columns: 1fr 1fr} }
</style>
</head>
<body class="cute">
  <div class="wrap">
    <header>
      <div class="title"><h1>Spank Game</h1></div>
      <div class="controls-top card" style="gap:12px;">
        <div>
          <span class="label">進入模式：</span>
          <select id="entryMode">
            <option value="newbie" selected>新手模式</option>
            <option value="hard">討打模式</option>
            <option value="infinite">無限模式</option>
          </select>
        </div>
        <div>
          <span class="label">最大挨打次數：</span>
          <input id="maxHitsInput" type="number" min="1" max="9999" value="500" style="width:120px">
        </div>
        <button id="startBtn" title="套用以上設定開始遊戲">開始遊戲</button>
      </div>
    </header>

    <div id="gameArea" class="grid" style="display:none;">
      <!-- 左：結果 + 按鈕 + 狀態 -->
      <section class="card">
        <div class="stats">
          <div class="stat">分數：<span id="score">0</span></div>
          <div class="stat">紅屁屁值：<span id="luck">5</span></div>
          <div class="stat">總挨打：<span id="hits">0</span></div>
          <div class="stat">上限：<span id="maxHitsView">500</span></div>
          <div class="stat">模式：<span id="modeView">新手模式</span></div>
        </div>

        <div id="result" class="big-result">準備好抽籤吧！</div>

        <div class="btnrow">
          <button id="drawBtn">抽籤</button>
          <button id="endBtn">結束</button>
          <button id="resetBtn">重新開始</button>
        </div>
      </section>

      <!-- 右：說明 + 歷史 -->
      <aside class="two-col">
        <div class="card info" id="infoBox">
          <h3 style="margin-top:0">模式說明</h3>
          <p><b>新手模式：</b>打<span class="warn">5~50</span>下；有護盾與分數加倍；首抽無減半/歸零。</p>
          <p><b>討打模式：</b>打<span class="warn">20~80</span>下；無護盾/加倍；紅屁屁值 &gt; 50 不會出現減半/歸零。</p>
          <p><b>無限模式：</b>打<span class="warn">20~100</span>下；只有懲罰事件，分數永遠為 0；只看總挨打是否超過上限。</p>
          <div style="margin-top:8px">
            <span class="label">遊戲中切換模式：</span>
            <select id="liveMode">
              <option value="newbie" selected>新手模式</option>
              <option value="hard">討打模式</option>
              <option value="infinite">無限模式</option>
            </select>
          </div>
        </div>

        <div class="card history">
          <h3>抽籤歷史</h3>
          <ul id="historyList"></ul>
        </div>
      </aside>
    </div>
  </div>

<script>
(() => {
  const tools = ["巴掌","戒尺","浴刷","小紅","小綠","塑膠棍","小黑棍","藤條","木板"];

  // State
  let mode = "newbie"; // newbie | hard | infinite
  let score = 0;
  let luck = 5; // 紅屁屁值
  let totalHits = 0;
  let maxHits = 500;
  let firstDraw = true;
  let nextTriple = false;
  let luckyDouble = false;   // only newbie
  let shieldActive = false;  // only newbie
  let rolling = false;
  let rollTimer = null;

  // Elements
  const body = document.body;
  const entryMode = document.getElementById("entryMode");
  const maxHitsInput = document.getElementById("maxHitsInput");
  const startBtn = document.getElementById("startBtn");
  const gameArea = document.getElementById("gameArea");

  const scoreEl = document.getElementById("score");
  const luckEl = document.getElementById("luck");
  const hitsEl = document.getElementById("hits");
  const maxHitsView = document.getElementById("maxHitsView");
  const modeView = document.getElementById("modeView");

  const resultEl = document.getElementById("result");
  const drawBtn = document.getElementById("drawBtn");
  const endBtn = document.getElementById("endBtn");
  const resetBtn = document.getElementById("resetBtn");
  const historyList = document.getElementById("historyList");
  const liveModeSel = document.getElementById("liveMode");

  function randInt(min, max){ return Math.floor(Math.random()*(max-min+1)) + min; }

  // sounds
  function playClick(){
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type='square';
    o.frequency.value=800;
    g.gain.setValueAtTime(0.05, ctx.currentTime);
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime+0.05);
  }
  function playDing(){
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type='sine';
    o.frequency.setValueAtTime(1200, ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(2000, ctx.currentTime+0.3);
    g.gain.setValueAtTime(0.1, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.3);
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime+0.3);
  }

  function setThemeByMode(m){
    body.classList.remove("cute","cool","danger");
    if(m==="newbie") body.classList.add("cute");
    else if(m==="hard") body.classList.add("cool");
    else body.classList.add("danger");
    modeView.textContent = m==="newbie"?"新手模式":(m==="hard"?"討打模式":"無限模式");
  }

  function appendHistory(text){
    const li=document.createElement('li');
    li.textContent=text;
    historyList.prepend(li);
    while(historyList.children.length>300) historyList.removeChild(historyList.lastChild);
  }

  function render(){
    scoreEl.textContent = score;
    luckEl.textContent = luck;
    hitsEl.textContent = totalHits;
    maxHitsView.textContent = maxHits;
  }

  function endGame(reason){
    drawBtn.disabled = true;
    resultEl.classList.remove("rolling");
    const msg = reason || `懲罰結束！總共挨打 ${totalHits} 下！🎉`;
    resultEl.textContent = msg;
    appendHistory(`*** 結束：${msg} ***`);
    alert(msg);
  }

  // 抽一次（含事件機率、限制）
  function drawOnce(){
    // 終止條件
    if(mode!=="infinite" && score>=100){
      endGame(`分數達到 100（${score}）`);
      return;
    }
    if(totalHits>=maxHits){
      endGame(`超過最大挨打上限 ${maxHits} 下（實際 ${totalHits}）`);
      return;
    }

    let message = "";
    // 範圍
    let penMin=5, penMax=50, gainMin=1, gainMax=20;
    if(mode==="hard"){ penMin=20; penMax=80; gainMin=1; gainMax=15; }
    if(mode==="infinite"){ penMin=20; penMax=100; }

    // 無限模式：只有懲罰
    if(mode==="infinite"){
      const times = randInt(penMin, penMax) * (nextTriple?3:1);
      nextTriple=false;
      const tool = ["巴掌","戒尺","浴刷","小紅","小綠","塑膠棍","小黑棍","藤條","木板"][randInt(0,8)];
      totalHits += times;
      luck += 1;
      message = `懲罰：${tool} × ${times} 次（紅屁屁值 +1）`;
      resultEl.textContent = `${tool} ${times} 下`;
      appendHistory(`${message}（分數：${score}，紅屁屁：${luck}，總挨打：${totalHits}）`);
      render();
      if(totalHits>=maxHits){ endGame(`超過最大挨打上限 ${maxHits} 下（實際 ${totalHits}）`); }
      return;
    }

    // ---------- 機率 ----------
    // 新手：懲罰 30%、減半 12%、歸零 5%、護盾 2%、加倍 1%、下一輪*3 2%、其餘加分
    // 討打：懲罰 50%、加分 30%，其餘事件占 20%（首抽不出減半/歸零；紅屁屁值>50 不出減半/歸零；無護盾/加倍）
    let weights = {};
    if(mode==="newbie"){
      weights = { penalty:30, half:12, zero:5, shield:2, double:1, triple:2 };
      if(firstDraw){ weights.half=0; weights.zero=0; }
      const fixed = Object.values(weights).reduce((a,b)=>a+b,0);
      weights.gain = Math.max(0, 100 - fixed); // 約 50%
    }else{ // hard
      const others = { half:20, zero:10, triple:2 };
      if(firstDraw || luck>50){ others.half = 0; others.zero = 0; }
      const sumO = (others.half||0)+(others.zero||0)+others.triple; // 32 或 2
      const scale = sumO>0 ? 20/sumO : 0;  // 縮放到剩餘 20%
      weights = { penalty:50, gain:30, half:(others.half||0)*scale, zero:(others.zero||0)*scale, triple:others.triple*scale };
    }

    // 正規化
    const totalW = Object.values(weights).reduce((a,b)=>a+b,0);
    Object.keys(weights).forEach(k=>weights[k]=weights[k]/totalW);

    const r = Math.random();
    let acc = 0;
    function pass(k){ acc+=weights[k]||0; return r<acc; }

    if(pass("gain")){
      // 加分（新手可能加倍）
      let pts = randInt(gainMin, gainMax);
      if(mode==="newbie" && luckyDouble){ pts*=2; luckyDouble=false; message+='🎉 幸運加倍！\n'; }
      score += pts;
      if(luck>0) luck -= 1;
      message += `加分 +${pts} 分（紅屁屁值 -1）`;
      resultEl.textContent = message;
    }
    else if(pass("penalty")){
      if(mode==="newbie" && shieldActive){
        message='🛡️ 護盾生效，本輪懲罰免除！';
        shieldActive=false;
        resultEl.textContent = message;
      }else{
        let times = randInt(penMin, penMax);
        if(nextTriple){ times*=3; nextTriple=false; }
        const tool = tools[randInt(0,tools.length-1)];
        totalHits += times;
        luck += 1;
        message = `懲罰：${tool} × ${times} 次（紅屁屁值 +1）`;
        resultEl.textContent = `${tool} ${times} 下`;
      }
    }
    else if(pass("half")){
      score = Math.floor(score/2);
      message = `事件：分數減半！`;
      resultEl.textContent = message;
    }
    else if(pass("zero")){
      score = 0;
      message = `災難事件：分數歸零！`;
      resultEl.textContent = message;
    }
    else if(pass("triple")){
      nextTriple = true;
      message = `特殊事件：下一輪懲罰次數 ×3！`;
      resultEl.textContent = message;
    }
    else if(mode==="newbie" && pass("double")){
      luckyDouble = true;
      message = '🎉 幸運事件：下一次加分翻倍！';
      resultEl.textContent = message;
    }
    else if(mode==="newbie" && pass("shield")){
      shieldActive = true;
      message = '🛡️ 護盾事件：下一次懲罰免除！';
      resultEl.textContent = message;
    }else{
      // 浮點殘差保底處理：小幅加分
      let pts = randInt(gainMin, Math.max(gainMin, Math.floor(gainMax/2)));
      score += pts;
      if(luck>0) luck -= 1;
      message = `加分 +${pts} 分（紅屁屁值 -1）`;
      resultEl.textContent = message;
    }

    firstDraw = false;
    render();
    appendHistory(`${message}（分數：${score}，紅屁屁：${luck}，總挨打：${totalHits}）`);
    if(mode!=="infinite" && score>=100){ endGame(`分數達到 100（${score}）`); return; }
    if(totalHits>=maxHits){ endGame(`超過最大挨打上限 ${maxHits} 下（實際 ${totalHits}）`); }
  }

  function doDrawFinal(){
    drawOnce();
    rolling=false;
    drawBtn.disabled=false;
    resultEl.classList.remove("rolling");
    playDing();
  }

  function doDrawWithAnimation(){
    rolling=true;
    drawBtn.disabled=true;
    resultEl.classList.add("rolling");
    let rolls=0, maxRolls=randInt(15,25);
    if(rollTimer) clearInterval(rollTimer);
    rollTimer = setInterval(()=>{
      const tool = tools[randInt(0,tools.length-1)];
      const rmin = (mode==="newbie")?5:(mode==="hard")?20:20;
      const rmax = (mode==="newbie")?50:(mode==="hard")?80:100;
      const hits = randInt(rmin,rmax);
      resultEl.textContent = `${tool} ${hits} 下`;
      playClick();
      rolls++;
      if(rolls>maxRolls){ clearInterval(rollTimer); doDrawFinal(); }
    },50);
  }

  // 事件
  startBtn.addEventListener("click", ()=>{
    mode = entryMode.value;
    setThemeByMode(mode);
    const val = parseInt(maxHitsInput.value||500,10);
    maxHits = Math.min(9999, Math.max(1, isNaN(val)?500:val));
    maxHitsInput.value = maxHits;
    score=0; luck=5; totalHits=0; firstDraw=true; nextTriple=false; luckyDouble=false; shieldActive=false;
    render();
    resultEl.textContent = "開始吧！";
    gameArea.style.display = "grid";
    liveModeSel.value = mode;
  });

  liveModeSel.addEventListener("change", (e)=>{
    mode = e.target.value;
    setThemeByMode(mode);
    resultEl.textContent = "模式已切換：" + (mode==="newbie"?"新手模式":mode==="hard"?"討打模式":"無限模式");
  });

  drawBtn.addEventListener("click", ()=>{
    if(!rolling) doDrawWithAnimation();
  });

  endBtn.addEventListener("click", ()=>{
    endGame(`手動結束，本次總挨打 ${totalHits} 下`);
  });

  resetBtn.addEventListener("click", ()=>{
    if(rollTimer) clearInterval(rollTimer);
    score=0; luck=5; totalHits=0; firstDraw=true; nextTriple=false; luckyDouble=false; shieldActive=false;
    resultEl.textContent = "已重新開始（數值重置）";
    render();
    drawBtn.disabled=false;
  });

  // 初始
  render();
  setThemeByMode("newbie");
})();
</script>
</body>
</html>
